{{ define "index" }}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Domain Finder</title>

    <style>
      .item-available {
        color: black;
      }
      .item-unavailable {
        color: lightgray;
      }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  </head>
  <body>

    <input type="text" id="word" />
    <button id="send">Send</button>

    <ul id="list">

    </ul>

    <script src="https://js.pusher.com/4.1/pusher.min.js"></script>
    <script type="text/javascript">
      var PusherKey = "{{ .PusherKey }}"
    </script>
    <script>

      // Enable pusher logging - don't include this in production
      // Pusher.logToConsole = true;

      var pusher = new Pusher(PusherKey, {
        cluster: 'eu',
        encrypted: true
      });

      var channel = pusher.subscribe('Domains');

      var w = $("#word")
      var l = $("#list")

      $("#send").click(function() {
        var v = w.val()
        w.val("")
        l.html("")
        var key = genKey()
        if (v) {
          $.get("/domains?word="+v+"&key="+key, function(event) {
            // and error occured
          })
          channel.bind('Result-'+key, function(data) {
            var a = data.available ? "" : "un";
            var html = "<li class='item-" + a +"available'>"
            html += "<a href='http://" + data.name +"' target='_blank'>" + data.name + "</a>"
            html += " is " + a + "available. </li>"

            l.html(l.html() + html)
          });
          channel.bind('End-'+key, function(data) {
            console.log("Unbind from " + key)
            channel.unbind('Result-'+key)
            channel.unbind('End-'+key)
          });
        }
      })


      function genKey() {
        return "" + Date.now() + "_" + Math.floor(Math.random() * 1000)
      }
    </script>
  </body>
</html>
{{ end }}
